<div align="center">

# Quiz App Backend

RESTful backend for a quiz management platform, built with **Node.js**, **Express 5**, **TypeScript**, and **Prisma** (SQLite by default). It supports role-based access for admins and users, quiz creation/attempt flows, and automated validation via **Zod**.

</div>

---

## Table of Contents

- [Tech Stack](#tech-stack)
- [Project Structure](#project-structure)
- [Prerequisites](#prerequisites)
- [Local Setup](#local-setup)
- [Environment Variables](#environment-variables)
- [Available Scripts](#available-scripts)
- [Core Features](#core-features)
- [Authentication & Access Control](#authentication--access-control)
- [API Reference](#api-reference)
  - [Auth Routes](#auth-routes)
  - [User Routes](#user-routes)
  - [Quiz Routes](#quiz-routes)
- [Swagger Documentation](#swagger-documentation)
- [Troubleshooting](#troubleshooting)

---

## Tech Stack

- **Runtime:** Node.js 20+, Express 5
- **Language:** TypeScript
- **Database:** SQLite (via Prisma ORM)
- **Validation:** Zod
- **Auth:** JWT (Bearer or httpOnly cookie)
- **Documentation:** Swagger UI (`/docs`)

## Project Structure

```
quiz-app-backend/
├─ prisma/
│  ├─ migrations/          # Generated by Prisma (optional)
│  └─ schema.prisma        # Database schema & models
├─ src/
│  ├─ controllers/         # Route handlers delegating to services
│  ├─ index.ts             # Express app entry point
│  ├─ lib/                 # Thin database access wrappers
│  ├─ middleware/          # Authentication & role guards
│  ├─ prismaClient.ts      # Singleton Prisma client instance
│  ├─ routes/              # Express routers (auth, users, quiz)
│  ├─ services/            # Business logic (auth, quiz, user)
│  ├─ swagger.ts           # Swagger configuration
│  ├─ types.ts             # Shared TypeScript types
│  ├─ utils/               # Helpers (auth, question sanitizers, etc.)
│  └─ validationSchema/    # Zod schemas & middleware
├─ .env                    # Environment variables (create yourself)
├─ package.json            # Scripts & dependencies
├─ tsconfig.json           # TypeScript compiler options
└─ yarn.lock               # Dependency lockfile
```

## Prerequisites

- Node.js **>= 20**
- Yarn **>= 1.22** (or npm, adjust commands accordingly)
- SQLite (bundled with the repo via Prisma; no external service required)

## Local Setup

1. **Clone the repository**
   ```bash
   git clone https://github.com/shreeraj-shinde/quiz-app-backend.git
   cd quiz-app-backend
   ```

2. **Install dependencies**
   ```bash
   yarn install
   ```

3. **Create the `.env` file** (see [Environment Variables](#environment-variables)).

4. **Generate the SQLite database & Prisma client**
   ```bash
   yarn prisma db push
   yarn prisma generate
   ```

5. **Start the development server**
   ```bash
   yarn dev
   ```
   The API is available at `http://localhost:5000` by default. Swagger UI lives at `http://localhost:5000/docs`.

6. *(Optional)* **Run the compiled build**
   ```bash
   yarn build
   node dist/index.js
   ```

## Environment Variables

Create a `.env` file at the project root with the following keys:

```
PORT=5000
DATABASE_URL="file:./dev.db"   # Prisma SQLite URL
JWT_SECRET=super-secret-key     # Used by JWT generation & verification
NODE_ENV=development
```

> **Note:** `DATABASE_URL` defaults to `file:./dev.db`. Adjust it if you switch to PostgreSQL/MySQL.

## Available Scripts

- `yarn dev` – Start the server with `ts-node-dev` (hot reload).
- `yarn build` – Compile TypeScript into `dist/`.
- `yarn start` – Push database schema, regenerate Prisma client, then run the built server.
- `yarn prisma db push` – Apply Prisma schema to the configured database.
- `yarn prisma generate` – Generate the Prisma client.

## Core Features

- **Authentication:** Email/password login with hashed credentials and JWT issuance.
- **Role Management:** Supports `ADMIN` and `USER` roles (see `prisma/schema.prisma`).
- **Quiz Authoring (Admin):** Create, update, delete quizzes with nested questions/options.
- **Quiz Discovery:** List quizzes, fetch by ID, and retrieve sanitized question sets.
- **Quiz Attempts (User):** Submit answers with auto-scoring for MCQ/True-False/Fill-in-the-blank.
- **Validation:** Zod schemas enforce payload shape on every route.
- **Swagger Docs:** Interactive API docs generated at runtime.

## Authentication & Access Control

- JWT tokens are generated by `src/utils/auth.utils.ts` and validated via `src/middleware/auth.middleware.ts`.
- Tokens can be supplied either in the `Authorization: Bearer <token>` header or as an httpOnly cookie named `token`.
- **Admin-only routes:** Quiz creation, update, and deletion (`/quiz/create`, `/quiz/:id` `PATCH/DELETE`).
- **Authenticated user routes:** All quiz retrieval/submit routes, user profile routes, etc.

## API Reference

All responses are JSON. Unless noted, error payloads use the shape:

```json
{
  "error": "Message describing the error",
  "details": [
    { "path": "field", "message": "Validation detail (optional)" }
  ]
}
```

### Auth Routes

- **POST `/auth/register`** – Register a new user (admin or regular).
  - **Required role:** Public.
  - **Request:**
    ```json
    {
      "name": "Jane Admin",
      "email": "jane@example.com",
      "password": "Passw0rd!",
      "role": "ADMIN"
    }
    ```
  - **Success (201):**
    ```json
    {
      "message": "User registered successfully"
    }
    ```

- **POST `/auth/login`** – Authenticate a user and retrieve a JWT.
  - **Required role:** Public.
  - **Request:**
    ```json
    {
      "email": "jane@example.com",
      "password": "Passw0rd!"
    }
    ```
  - **Success (200):**
    ```json
    {
      "message": "Login successful",
      "user": {
        "id": "<user-id>",
        "name": "Jane Admin",
        "email": "jane@example.com",
        "role": "ADMIN"
      },
      "token": "<jwt-token>"
    }
    ```
  - Response also sets an httpOnly cookie named `token` for browser clients.

### User Routes

- **GET `/users/`** – Retrieve all users.
  - **Required role:** Authenticated (`ADMIN` or `USER`).
  - **Success (200):**
    ```json
    [
      {
        "id": "<user-id>",
        "name": "Jane Admin",
        "email": "jane@example.com",
        "role": "ADMIN"
      }
    ]
    ```

- **GET `/users/profile`** – Fetch the current authenticated user profile.
  - **Required role:** Authenticated.
  - **Success (200):**
    ```json
    {
      "id": "<user-id>",
      "name": "John Doe",
      "email": "john@example.com",
      "role": "USER"
    }
    ```

- **GET `/users/:id`** – Fetch a specific user by ID.
  - **Required role:** Authenticated.
  - **Success (200):** Same payload as `/users/profile`.

### Quiz Routes

- **POST `/quiz/create`** – Create a quiz (admin-only).
  - **Required role:** `ADMIN`.
  - **Headers:** `Authorization: Bearer <token>` (or `token` cookie).
  - **Request:**
    ```json
    {
      "title": "JavaScript Basics",
      "description": "Core concepts quiz",
      "questions": [
        {
          "text": "Which statements about const variables are accurate?",
          "type": "MCQ_MULTIPLE",
          "timeLimit": 120,
          "options": [
            { "text": "Must be initialized", "isCorrect": true },
            { "text": "Prevents reassignment", "isCorrect": true },
            { "text": "Can be redeclared", "isCorrect": false },
            { "text": "Objects cannot mutate", "isCorrect": false }
          ]
        }
      ]
    }
    ```
  - **Success (201):** Returns the created quiz, including generated IDs.

- **PATCH `/quiz/:id`** – Update quiz metadata or add questions.
  - **Required role:** `ADMIN`.
  - **Request:**
    ```json
    {
      "title": "Updated Quiz Title",
      "description": "Optional description",
      "questions": [
        {
          "text": "New True/False question",
          "type": "TRUE_FALSE",
          "timeLimit": 30,
          "options": [
            { "text": "True", "isCorrect": true },
            { "text": "False", "isCorrect": false }
          ]
        }
      ]
    }
    ```
  - **Success (200):** Sanitized quiz (options omit `isCorrect`).

- **DELETE `/quiz/:id`** – Delete a quiz.
  - **Required role:** `ADMIN`.
  - **Success (200):**
    ```json
    {
      "message": "Quiz deleted successfully"
    }
    ```

- **GET `/quiz/getQuestions/:id`** – Retrieve questions for a quiz without exposing answers.
  - **Required role:** Authenticated.
  - **Success (200):**
    ```json
    [
      {
        "id": "<question-id>",
        "text": "Which statements about const variables are accurate?",
        "type": "MCQ_MULTIPLE",
        "timeLimit": 120,
        "options": [
          { "id": "<option-id>", "text": "Must be initialized" },
          { "id": "<option-id>", "text": "Prevents reassignment" },
          { "id": "<option-id>", "text": "Can be redeclared" },
          { "id": "<option-id>", "text": "Objects cannot mutate" }
        ]
      }
    ]
    ```

- **GET `/quiz/all`** – List all quizzes with attempted flag.
  - **Required role:** Authenticated.
  - **Success (200):**
    ```json
    [
      {
        "id": "<quiz-id>",
        "title": "JavaScript Basics",
        "description": "Core concepts quiz",
        "isAttempted": false
      }
    ]
    ```

- **GET `/quiz/:id`** – Retrieve quiz details for the authenticated user.
  - **Required role:** Authenticated.
  - **Success (200):**
    ```json
    {
      "id": "<quiz-id>",
      "title": "JavaScript Basics",
      "description": "Core concepts quiz",
      "createdAt": "2024-01-01T12:00:00.000Z",
      "questions": [
        {
          "id": "<question-id>",
          "text": "Which statements about const variables are accurate?",
          "type": "MCQ_MULTIPLE",
          "timeLimit": 120,
          "options": [
            { "id": "<option-id>", "text": "Must be initialized" },
            { "id": "<option-id>", "text": "Prevents reassignment" },
            { "id": "<option-id>", "text": "Can be redeclared" },
            { "id": "<option-id>", "text": "Objects cannot mutate" }
          ]
        }
      ],
      "isAttempted": true
    }
    ```

- **POST `/quiz/submit/:id`** – Submit quiz answers and receive a score.
  - **Required role:** `USER` (authenticated non-admin).
  - **Request:**
    ```json
    {
      "answers": [
        {
          "questionId": "<question-id>",
          "selectedOptionIds": [
            "<correct-option-id-1>",
            "<correct-option-id-2>"
          ]
        }
      ]
    }
    ```
  - **Success (200):**
    ```json
    {
      "quizId": "<quiz-id>",
      "userId": "<user-id>",
      "score": 1,
      "total": 1,
      "resultId": "<result-id>",
      "details": [
        {
          "questionId": "<question-id>",
          "correct": true,
          "expected": "[\"<correct-option-id-1>\",\"<correct-option-id-2>\"]",
          "received": "[\"<correct-option-id-1>\",\"<correct-option-id-2>\"]"
        }
      ]
    }
    ```

## Swagger Documentation

- Interactive documentation is served by `setupSwagger()` in `src/swagger.ts`.
- Visit `http://localhost:${PORT}/docs` for the UI or `http://localhost:${PORT}/swagger.json` for the raw spec.
- The spec is generated from the source and `swaggerDefinition` object; update it as routes evolve.

## Testing

- **Current status:** Automated tests are not yet configured. Jest + Supertest are recommended for route coverage.
- **Suggested setup:**
  1. Install dev dependencies:
     ```bash
     yarn add -D jest ts-jest @types/jest supertest @types/supertest
     ```
  2. Initialize Jest config for TypeScript:
     ```bash
     npx ts-jest config:init
     ```
  3. Create test suites under `tests/` or alongside modules (e.g., `src/routes/__tests__/quiz.route.test.ts`).
  4. Mock Prisma by extracting `prisma` from `src/prismaClient.ts` and using dependency injection or jest mocks.
  5. Add a script to `package.json`:
     ```json
     "scripts": {
       "test": "jest --runInBand"
     }
     ```
  6. Run tests with:
     ```bash
     yarn test
     ```
- **Manual verification:**
  - Use tools like Postman/Thunder Client.
  - Seed users through `/auth/register` to create admin/user roles.
  - Authenticate via `/auth/login`, capture the JWT or cookie, and exercise protected endpoints.

## Deployment

- **Production build:**
  1. Set environment variables (`PORT`, `DATABASE_URL`, `JWT_SECRET`, `NODE_ENV=production`).
  2. Install dependencies: `yarn install --production` (or `npm ci --omit dev`).
  3. Generate database schema and Prisma client:
     ```bash
     yarn prisma db push
     yarn prisma generate
     ```
  4. Build the project: `yarn build`.
  5. Start the server: `node dist/index.js` or `yarn start` (runs db push + generate + start).

- **Database migrations:**
  - Use `yarn prisma migrate dev --name <migration-name>` during development.
  - Promote migrations with `yarn prisma migrate deploy` in production.

- **Process management:**
  - Use PM2, systemd, or Docker to manage the Node process.
  - Ensure the `.env` is loaded (e.g., via systemd `EnvironmentFile` or Docker secrets).

- **Docker (optional outline):**
  - Create a `Dockerfile` that copies the project, runs `yarn install`, `yarn build`, and executes `node dist/index.js`.
  - Bind mount or copy Prisma migrations and ensure the container runs migrations on startup.

## Troubleshooting

- **Prisma cannot connect:** Ensure `DATABASE_URL` points to a valid SQLite file. Run `yarn prisma db push` after changes to `prisma/schema.prisma`.
- **JWT errors:** Check `JWT_SECRET` in `.env`. Login and protected routes rely on it.
- **Role access issues:** Verify the `role` column for your user in the database and ensure correct middleware order (`authenticate`, `requireAdmin`, `requireUser`).
- **Validation failures:** Review Zod schemas under `src/validationSchema/` for required fields.

---

Happy hacking! 🎯
